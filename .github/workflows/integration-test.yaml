name: Integration Tests

on:
  workflow_dispatch:
  # Triggers the workflow to run every Monday & Thursday at 0900
  schedule:
  - cron: "0 9 * * 1,4"
jobs:
  Build:
    runs-on: ubuntu-latest
    env:
        working-directory: gaffer-docker
    steps:    
    - uses: actions/checkout@v2

    - name: Install Kubernetes
      run: ./cd/before_install.sh
   
    - name: Build images
      run: |
        ./cd/build_images.sh
        docker build -t gchq/gaffer-integration-tests:1.15.0 ./docker/gaffer-integration-tests/

    - name: Install subcharts
      run: ./cd/install_dependencies.sh    

    - name: Deploy to Kubernetes
      run: |
        kind create cluster
        kind load docker-image gchq/hdfs:3.2.1
        kind load docker-image gchq/gaffer:1.15.0
        kind load docker-image gchq/gaffer-rest:1.15.0
        kind load docker-image gchq/gaffer-ui:1.15.0
        kind load docker-image gchq/gaffer-operation-runner:1.15.0
        kind load docker-image gchq/gaffer-integration-tests:1.15.0
        kind load docker-image gchq/accumulo:1.9.3
        helm install gaffer ./kubernetes/gaffer -f ./kubernetes/gaffer/integration-tests.yaml
      
    - name: Run Tests
      run: helm test gaffer --timeout 30m      

    - name: Send success message to ms teams
      if: ${{ success()}}
      uses: fjogeleit/http-request-action@master
      with:
          url: ${{ secrets.WORKFLOW_URL}}
          method: 'POST'
          contentType: "application/json"
          data: "{'message': 'gaffer succesfully deployed and integration tests run'}"  

      
    
    - name: Send failure message to ms teams
      if: ${{ failure()}}
      uses: fjogeleit/http-request-action@master
      with:
          url: ${{ secrets.WORKFLOW_URL}}
          method: 'POST'
          contentType: "application/json"
          data: "{'message': 'Running integration tests unsuccessful'}"  

     
       
    
      
       